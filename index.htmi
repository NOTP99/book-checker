<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„ì„œ í™•ì¸ í”„ë¡œê·¸ë¨</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (Excel Parser) CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+KR:wght@100..900&display=swap');
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Hide the loading screen initially */
        #loading-overlay { display: none; }
        
        /* 1. ì…ë ¥ ëª¨ë“œ ê°•ì œ ì „í™˜ì„ ìœ„í•œ CSS (ì¼ë¶€ êµ¬í˜• ë¸Œë¼ìš°ì €ì—ì„œ ìœ íš¨) */
        #scan-input:focus {
            ime-mode: inactive; /* í•œì˜ ìë™ ì „í™˜ ì‹œë„ë¥¼ ìœ„í•œ íŒíŠ¸ë§Œ ìœ ì§€ */
        }
        /* ì‚¬ìš©ìì—ê²Œ í´ë¦­ ê°€ëŠ¥í•¨ì„ ì‹œê°ì ìœ¼ë¡œ ì•Œë ¤ì¤Œ */
        .toggle-status {
            cursor: pointer;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-6">

    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6 md:p-8">
        <header class="mb-6 border-b pb-4">
            <h1 class="text-3xl font-bold text-gray-800">ğŸ“š ë„ì„œ í™•ì¸ í”„ë¡œê·¸ë¨</h1>
            <p class="text-gray-500 mt-1">ì—‘ì…€ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¨ í›„, ë“±ë¡ ë²ˆí˜¸, ISBN, ë˜ëŠ” ì„œëª…ì„ í†µí•´ ì¬ê³ ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸í•˜ì„¸ìš”.</p>
        </header>

        <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
        <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-2xl flex items-center">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="loading-text" class="text-gray-700">ëª©ë¡ì„ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</span>
            </div>
        </div>

        <!-- 1. ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ -->
        <section class="mb-6 p-4 border-2 border-dashed border-indigo-300 rounded-lg bg-indigo-50">
            <h2 class="text-xl font-semibold text-indigo-700 mb-2">1. ì—‘ì…€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ì„œëª…, ISBN, ë“±ë¡ ë²ˆí˜¸ í•„ìˆ˜)</h2>
            <p class="text-sm text-indigo-600 mb-3">ì—‘ì…€ íŒŒì¼ì˜ ì²« ë²ˆì§¸ ì‹œíŠ¸ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤. **'ì„œëª…'**, **'ISBN'**, **'ë“±ë¡ ë²ˆí˜¸'** ì—´ì´ í¬í•¨ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</p>
            <input type="file" id="excel-file" accept=".xlsx, .xls, .csv" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-500 file:text-white hover:file:bg-indigo-600 cursor-pointer">
            <p id="file-status" class="mt-2 text-sm font-medium text-red-500"></p>
        </section>

        <!-- 2. ì¬ê³  í™•ì¸ (ìŠ¤ìº”/ì…ë ¥) -->
        <section class="mb-8 p-6 bg-gray-100 rounded-lg shadow">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">2. ë„ì„œ í™•ì¸í•˜ê¸° (ìŠ¤ìº” ë˜ëŠ” ì…ë ¥)</h2>
            <div id="check-area" class="opacity-50 pointer-events-none transition duration-300">
                
                <!-- A. í…ìŠ¤íŠ¸ ì…ë ¥/ìŠ¤ìº” ì˜ì—­ -->
                <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3 mb-4">
                    <input type="text" id="scan-input" placeholder="ë“±ë¡ ë²ˆí˜¸, ISBN ë˜ëŠ” ì±… ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: HC000797, 97889...)"
                        class="flex-grow p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500 text-lg" 
                        disabled
                        inputmode="verbatim" lang="en" spellcheck="false">
                    <button id="check-button" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-200 disabled:bg-indigo-300" disabled>
                        ì¬ê³  í™•ì¸
                    </button>
                </div>
                
                <div id="check-result" class="mt-4 text-center font-bold text-xl min-h-[30px]"></div>
            </div>
        </section>

        <!-- 3. ë„ì„œ ëª©ë¡ ë° í˜„í™© -->
        <section>
            <h2 class="text-xl font-semibold text-gray-800 mb-4">3. ë„ì„œ ëª©ë¡ í˜„í™© (<span id="checked-count">0</span> / <span id="total-count">0</span> ê¶Œ í™•ì¸)</h2>
            <div class="flex flex-wrap gap-3 mb-4">
                <button id="export-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 disabled:bg-green-300" disabled>
                    âœ… í™•ì¸ ëª©ë¡ ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸° (.xlsx)
                </button>
                <button id="filter-button" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 disabled:bg-gray-300" disabled>
                    ğŸ” ë¯¸í™•ì¸ ë„ì„œë§Œ ë³´ê¸°
                </button>
            </div>
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table id="book-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-indigo-600 text-white">
                        <tr>
                            <!-- í­ ì¡°ì •: ìƒíƒœ(1/12), ì œëª©(4/12), ISBN(3/12), ë“±ë¡ ë²ˆí˜¸(3/12), ë¹„ê³ (1/12) -->
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider w-1/12 rounded-tl-lg">ìƒíƒœ</th>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider w-4/12">ì„œëª…</th>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider w-3/12">ISBN</th>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider w-3/12">ë“±ë¡ ë²ˆí˜¸</th>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider w-1/12 rounded-tr-lg">ë¹„ê³ </th>
                        </tr>
                    </thead>
                    <tbody id="book-list-body" class="bg-white divide-y divide-gray-200">
                        <!-- ì´ˆê¸° í”Œë ˆì´ìŠ¤í™€ë” ë°ì´í„° -->
                        <tr class="bg-gray-50"><td colspan="5" class="p-6 text-center text-gray-500 italic">ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- ë©”ì‹œì§€ ëª¨ë‹¬ (alert() ëŒ€ì²´) -->
        <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
                <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-800"></h3>
                <p id="modal-message" class="text-gray-600 mb-4"></p>
                <div class="flex justify-end">
                    <button id="modal-close-button" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">í™•ì¸</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ì „ì—­ ìƒíƒœ ë³€ìˆ˜
        let bookList = [];
        let totalBookCount = 0;
        let checkedBookCount = 0;
        let showUncheckedOnly = false; // [ê¸°ëŠ¥ 1] ëª©ë¡ í•„í„°ë§ ìƒíƒœ

        // HTML ìš”ì†Œ ì°¸ì¡°
        const excelFileEl = document.getElementById('excel-file');
        const fileStatusEl = document.getElementById('file-status');
        const scanInputEl = document.getElementById('scan-input');
        const checkButtonEl = document.getElementById('check-button');
        const checkResultEl = document.getElementById('check-result');
        const bookListBodyEl = document.getElementById('book-list-body');
        const checkAreaEl = document.getElementById('check-area');
        const totalCountEl = document.getElementById('total-count');
        const checkedCountEl = document.getElementById('checked-count');
        const loadingOverlayEl = document.getElementById('loading-overlay');
        const loadingTextEl = document.getElementById('loading-text');
        const exportButtonEl = document.getElementById('export-button');
        const filterButtonEl = document.getElementById('filter-button'); // [ê¸°ëŠ¥ 1] í•„í„° ë²„íŠ¼ ì°¸ì¡°

        // ëª¨ë‹¬ ìš”ì†Œ ì°¸ì¡°
        const messageModalEl = document.getElementById('message-modal');
        const modalTitleEl = document.getElementById('modal-title');
        const modalMessageEl = document.getElementById('modal-message');
        const modalCloseButtonEl = document.getElementById('modal-close-button');
        
        // **ì—‘ì…€ ì›ë³¸ í—¤ë”**
        let originalExcelHeaders = [];

        // ë¹„ê³  ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (HTMLì—ì„œ ì§ì ‘ í˜¸ì¶œë¨)
        function updateRemarks(index, value) {
            const bookIndex = parseInt(index, 10);
            if (bookIndex >= 0 && bookIndex < bookList.length) {
                const book = bookList[bookIndex];
                if (book) {
                    book.Remarks = value.trim();
                }
            }
        }

        // ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜ (alert() ëŒ€ì²´)
        function showMessage(title, message) {
            modalTitleEl.textContent = title;
            modalMessageEl.textContent = message;
            messageModalEl.classList.remove('hidden');
            messageModalEl.classList.add('flex');
        }

        modalCloseButtonEl.addEventListener('click', () => {
            messageModalEl.classList.add('hidden');
            messageModalEl.classList.remove('flex');
            scanInputEl.focus(); 
        });

        // UI ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateUIState(isLoaded) {
            if (isLoaded) {
                checkAreaEl.classList.remove('opacity-50', 'pointer-events-none');
                scanInputEl.disabled = false;
                checkButtonEl.disabled = false;
                exportButtonEl.disabled = false;
                filterButtonEl.disabled = false; // [ê¸°ëŠ¥ 1] í•„í„° ë²„íŠ¼ í™œì„±í™”
                scanInputEl.focus();
            } else {
                checkAreaEl.classList.add('opacity-50', 'pointer-events-none');
                scanInputEl.disabled = true;
                checkButtonEl.disabled = true;
                exportButtonEl.disabled = true;
                filterButtonEl.disabled = true; // [ê¸°ëŠ¥ 1] í•„í„° ë²„íŠ¼ ë¹„í™œì„±í™”
            }
        }
        
        // ì—‘ì…€ íŒŒì¼ì„ ì½ì–´ bookListë¥¼ ì±„ìš°ëŠ” í•¨ìˆ˜
        function loadExcel(event) {
            loadingTextEl.textContent = 'ëª©ë¡ì„ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...';
            loadingOverlayEl.style.display = 'flex';
            const file = event.target.files[0];
            if (!file) {
                loadingOverlayEl.style.display = 'none';
                return;
            }

            const fileName = file.name;
            const fileExt = fileName.split('.').pop().toLowerCase();
            if (!['xlsx', 'xls', 'csv'].includes(fileExt)) {
                showMessage("íŒŒì¼ í˜•ì‹ ì˜¤ë¥˜", "ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. .xlsx, .xls, .csv íŒŒì¼ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.");
                loadingOverlayEl.style.display = 'none';
                return;
            }

            fileStatusEl.textContent = `íŒŒì¼ ë¡œë“œ ì¤‘: ${fileName}`;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: true });

                    if (json.length === 0) {
                        showMessage("ë°ì´í„° ì˜¤ë¥˜", "ì—‘ì…€ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                        fileStatusEl.textContent = "";
                        updateUIState(false);
                        loadingOverlayEl.style.display = 'none';
                        return;
                    }

                    const headers = json[0];
                    const dataRows = json.slice(1);

                    originalExcelHeaders = headers.map(h => String(h || '').trim());
                    
                    const normalizedHeaders = headers.map(h => h ? h.toString().trim().toUpperCase() : '');
                    
                    const regNoIndex = normalizedHeaders.findIndex(h => h.includes('ë“±ë¡') && h.includes('ë²ˆí˜¸')); 
                    const isbnIndex = normalizedHeaders.findIndex(h => h.includes('ISBN'));
                    const titleIndex = normalizedHeaders.findIndex(h => h.includes('ì„œëª…') || h.includes('ì œëª©') || h.includes('TITLE'));
                    
                    const remarksIndex = normalizedHeaders.findIndex(h => h.includes('ë¹„ê³ ') || h.includes('REMARKS') || h.includes('COMMENT'));

                    if (regNoIndex === -1 || isbnIndex === -1 || titleIndex === -1) {
                        showMessage("í•„ìˆ˜ ì—´ ëˆ„ë½", `ì—‘ì…€ í—¤ë”ì—ì„œ 'ì„œëª…', 'ISBN', ë˜ëŠ” 'ë“±ë¡ ë²ˆí˜¸' ì—´ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                        fileStatusEl.textContent = "";
                        updateUIState(false);
                        loadingOverlayEl.style.display = 'none';
                        return;
                    }

                    bookList = dataRows.map(row => {
                        const title = row[titleIndex] ? String(row[titleIndex]).trim() : 'ì œëª© ì—†ìŒ';
                        const rawRegNo = row[regNoIndex] ? String(row[regNoIndex]).trim() : '';
                        const rawIsbn = row[isbnIndex] ? String(row[isbnIndex]).replace(/[^0-9X]/gi, '') : '';
                        const rawRemarks = remarksIndex !== -1 && row[remarksIndex] ? String(row[remarksIndex]).trim() : '';

                        let originalData = {};
                        originalExcelHeaders.forEach((header, i) => {
                            originalData[header] = row[i];
                        });

                        return {
                            OriginalData: originalData,
                            RegNo: rawRegNo,
                            ISBN: rawIsbn,
                            Title: title,
                            checked: false,
                            Remarks: rawRemarks
                        };
                    }).filter(book => book.ISBN || book.RegNo);

                    totalBookCount = bookList.length;
                    checkedBookCount = 0;
                    
                    fileStatusEl.textContent = `âœ… ${fileName} íŒŒì¼ ë¡œë“œ ì™„ë£Œ. ì´ ${totalBookCount}ê¶Œì˜ ë„ì„œ ëª©ë¡.`;
                    
                    updateUIState(true);
                    // íŒŒì¼ ë¡œë“œ ì‹œ í•„í„° ìƒíƒœ ì´ˆê¸°í™” ë° UI ì—…ë°ì´íŠ¸
                    showUncheckedOnly = false; 
                    filterButtonEl.textContent = 'ğŸ” ë¯¸í™•ì¸ ë„ì„œë§Œ ë³´ê¸°';
                    filterButtonEl.classList.remove('bg-orange-500', 'hover:bg-orange-600');
                    filterButtonEl.classList.add('bg-gray-400', 'hover:bg-gray-500');
                    renderList();

                    loadingOverlayEl.style.display = 'none';

                } catch (error) {
                    console.error("ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                    showMessage("ì²˜ë¦¬ ì˜¤ë¥˜", "ì—‘ì…€ íŒŒì¼ì„ ì²˜ë¦¬í•˜ëŠ” ë„ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. íŒŒì¼ ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                    fileStatusEl.textContent = "";
                    updateUIState(false);
                    loadingOverlayEl.style.display = 'none';
                }
            };

            reader.readAsArrayBuffer(file);
        }

        // [ê¸°ëŠ¥ 1] ë¯¸í™•ì¸ ë„ì„œë§Œ ë³´ê¸° í•„í„° í† ê¸€
        function toggleFilter() {
            showUncheckedOnly = !showUncheckedOnly;
            
            if (showUncheckedOnly) {
                filterButtonEl.textContent = 'âœ… ì „ì²´ ëª©ë¡ ë³´ê¸°';
                filterButtonEl.classList.remove('bg-gray-400', 'hover:bg-gray-500');
                filterButtonEl.classList.add('bg-orange-500', 'hover:bg-orange-600');
            } else {
                filterButtonEl.textContent = 'ğŸ” ë¯¸í™•ì¸ ë„ì„œë§Œ ë³´ê¸°';
                filterButtonEl.classList.remove('bg-orange-500', 'hover:bg-orange-600');
                filterButtonEl.classList.add('bg-gray-400', 'hover:bg-gray-500');
            }

            renderList();
            scanInputEl.focus();
        }

        // [ê¸°ëŠ¥ 3] ëª©ë¡ì—ì„œ ì§ì ‘ ìƒíƒœë¥¼ í† ê¸€í•˜ëŠ” í•¨ìˆ˜
        function toggleCheckStatus(index) {
            if (index >= 0 && index < bookList.length) {
                // í˜„ì¬ ìƒíƒœë¥¼ ë°˜ì „
                bookList[index].checked = !bookList[index].checked;
                renderList();
                scanInputEl.focus(); // ìƒíƒœ ë³€ê²½ í›„ ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤ ìœ ì§€
            }
        }


        // ëª©ë¡ì„ HTML í…Œì´ë¸”ë¡œ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
        function renderList() {
            bookListBodyEl.innerHTML = ''; 
            checkedBookCount = bookList.filter(b => b.checked).length;

            totalCountEl.textContent = totalBookCount;
            checkedCountEl.textContent = checkedBookCount;
            
            // --- [ê¸°ëŠ¥ 1] í•„í„°ë§ ë¡œì§ ---
            let displayList = [...bookList];
            if (showUncheckedOnly) {
                displayList = displayList.filter(book => !book.checked);
            }
            // --- í•„í„°ë§ ë¡œì§ ë ---

            if (totalBookCount > 0 && displayList.length === 0) {
                let message = showUncheckedOnly 
                    ? 'ğŸ‰ í•„í„°ë§ëœ ë„ì„œê°€ ì—†ìŠµë‹ˆë‹¤. ëª¨ë“  ë„ì„œê°€ í™•ì¸ ì™„ë£Œë˜ì—ˆê±°ë‚˜, ëª©ë¡ í•„í„°ê°€ ì¼œì ¸ìˆìŠµë‹ˆë‹¤.'
                    : 'ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.';
                
                bookListBodyEl.innerHTML = `<tr class="bg-gray-50"><td colspan="5" class="p-6 text-center text-gray-500 italic">${message}</td></tr>`;
                
                // í•„í„°ê°€ ì¼œì ¸ìˆì–´ë„, ì „ì²´ ëª©ë¡ì´ ìˆë‹¤ë©´ ìŠ¤ìº” ê¸°ëŠ¥ì€ ìœ ì§€
                if (totalBookCount === 0) {
                    updateUIState(false);
                }
                return;
            } else if (totalBookCount === 0) {
                bookListBodyEl.innerHTML = '<tr class="bg-gray-50"><td colspan="5" class="p-6 text-center text-gray-500 italic">ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</td></tr>';
                updateUIState(false);
                return;
            }
            
            // í™•ì¸ëœ ì±…ì„ ë¨¼ì €, í™•ì¸ë˜ì§€ ì•Šì€ ì±…ì„ ë‚˜ì¤‘ì— í‘œì‹œ (ì •ë ¬)
            const sortedList = displayList.sort((a, b) => (a.checked === b.checked) ? 0 : a.checked ? -1 : 1);

            sortedList.forEach((book) => {
                const row = document.createElement('tr');
                const bgColor = book.checked ? 'bg-green-50' : (sortedList.indexOf(book) % 2 === 0 ? 'bg-white' : 'bg-gray-50');
                
                // [ê¸°ëŠ¥ 3] ìƒíƒœ í† ê¸€ì„ ìœ„í•œ ì•„ì´ì½˜ ë° í´ë˜ìŠ¤
                const checkIcon = book.checked 
                    ? '<span class="text-green-600 font-bold text-xl select-none">âœ“</span>' 
                    : '<span class="text-gray-400 select-none">â–¡</span>';
                
                // ì›ë³¸ bookList ë‚´ì—ì„œì˜ ì¸ë±ìŠ¤ (Remarks ì—…ë°ì´íŠ¸ì™€ ìƒíƒœ í† ê¸€ì„ ìœ„í•´ í•„ìš”)
                const originalIndex = bookList.findIndex(b => b === book); 

                const remarksCellContent = book.checked 
                    ? `<span class="text-gray-600 text-sm">${book.Remarks || '-'}</span>`
                    : `<input type="text" data-index="${originalIndex}" value="${book.Remarks}" placeholder="ëŒ€ì¶œ, íŒŒì† ë“± ì‚¬ìœ " 
                         class="w-full text-sm p-1 border border-gray-300 rounded focus:outline-none focus:border-indigo-400 bg-white"
                         onchange="updateRemarks(this.getAttribute('data-index'), this.value)">`;


                row.className = `${bgColor} hover:bg-indigo-100 transition duration-150`;
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-center toggle-status cursor-pointer" data-index="${originalIndex}">${checkIcon}</td>
                    <td class="px-4 py-3 font-medium text-gray-900">${book.Title}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${book.ISBN}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${book.RegNo}</td>
                    <td class="px-4 py-3 text-sm">${remarksCellContent}</td>
                `;
                bookListBodyEl.appendChild(row);
            });

            // [ê¸°ëŠ¥ 3] ì´ë²¤íŠ¸ ìœ„ì„ìœ¼ë¡œ ìƒíƒœ í† ê¸€ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            document.querySelectorAll('.toggle-status').forEach(cell => {
                cell.addEventListener('click', (e) => {
                    const index = e.currentTarget.getAttribute('data-index');
                    toggleCheckStatus(parseInt(index, 10));
                });
            });

            updateUIState(true); 
        }

        /**
         * ë“±ë¡ ë²ˆí˜¸ì˜ ìˆ«ì ë¶€ë¶„ì—ì„œ ì„ í–‰ 0ì„ ì œê±°í•˜ì—¬ ì˜ë¬¸ ì ‘ë‘ì‚¬ì™€ ì˜ë¯¸ ìˆëŠ” ìˆ«ì ë¶€ë¶„ë§Œ ë‚¨ê¹ë‹ˆë‹¤.
         */
        function stripLeadingZeros(regNo) {
            if (!regNo) return '';
            
            const match = regNo.match(/^([A-Z]*)([0-9]*)$/);
            if (!match) return regNo; 
            
            const prefix = match[1];
            let numericPart = match[2];

            const strippedNumeric = numericPart.replace(/^0+/, ''); 
            
            const resultNumeric = (strippedNumeric === '' && numericPart.length > 0) ? '0' : strippedNumeric;
            
            return prefix + resultNumeric;
        }

        /**
         * í•œê¸€ ì…ë ¥ ëª¨ë“œì—ì„œ ìŠ¤ìº”/ì…ë ¥ëœ ê°’ì„ QWERTY í‚¤ë³´ë“œ ìœ„ì¹˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì˜ë¬¸ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
         */
        function convertKoreanToEnglish(text) {
            if (!text) return '';
            
            const jamoMap = {
                'ã…‚': 'q', 'ã…ƒ': 'Q', 'ã…ˆ': 'w', 'ã…‰': 'W', 'ã„·': 'e', 'ã„¸': 'E', 'ã„±': 'r', 'ã„²': 'R', 'ã……': 't', 'ã…†': 'T',
                'ã…': 'a', 'ã„´': 's', 'ã…‡': 'd', 'ã„¹': 'f', 'ã…': 'g', 'ã…‹': 'z', 'ã…Œ': 'x', 'ã…Š': 'c', 'ã…': 'v',
                
                'ã…›': 'y', 'ã…•': 'u', 'ã…‘': 'i', 'ã…': 'o', 'ã…’': 'O', 'ã…”': 'p', 'ã…–': 'P',
                'ã…—': 'h', 'ã…“': 'j', 'ã…': 'k', 'ã…£': 'l', 'ã… ': 'b', 'ã…œ': 'n', 'ã…¡': 'm',
            };

            let convertedText = '';
            for (const char of text) {
                convertedText += jamoMap[char] || char;
            }

            return convertedText;
        }

        // ìŠ¤ìº” ì…ë ¥ê°’ì„ ì²˜ë¦¬í•˜ê³  ëª©ë¡ì—ì„œ ì±…ì„ ì°¾ì•„ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜ (í…ìŠ¤íŠ¸ ê¸°ë°˜)
        function searchAndCheck() {
            const rawInput = scanInputEl.value.trim();
            
            if (bookList.length === 0) {
                 checkResultEl.innerHTML = '<span class="text-orange-500">âš ï¸ ë¨¼ì € ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</span>';
                 scanInputEl.focus();
                 return;
            }

            if (rawInput.length < 3) {
                checkResultEl.innerHTML = '<span class="text-red-500">âŒ ìµœì†Œ 3ê¸€ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.</span>';
                scanInputEl.focus();
                return;
            }
            
            let correctedInput = convertKoreanToEnglish(rawInput);
            const inputUpper = correctedInput.toUpperCase();
            
            let foundBook = findBookInList(inputUpper);

            displayCheckResult(foundBook, rawInput); 

            scanInputEl.value = '';
            scanInputEl.focus();
        }

        // ì œëª© ê¸°ë°˜ ê²€ìƒ‰ ë¡œì§ì„ ë¶„ë¦¬í•˜ì—¬ ì‚¬ìš©
        function findBookInList(inputString) {
            const inputUpper = inputString.toUpperCase();
            
            let foundBook = null;

            // 1. ë“±ë¡ ë²ˆí˜¸ (RegNo) ì •ê·œí™” ë§¤ì¹­ ì‹œë„
            const normalizedInputRegNo = stripLeadingZeros(inputUpper);
            foundBook = bookList.find(book => {
                const normalizedBookRegNo = stripLeadingZeros(book.RegNo.toUpperCase());
                return normalizedBookRegNo === normalizedInputRegNo;
            });

            // 2. ISBNìœ¼ë¡œ ì •í™•íˆ ë§¤ì¹­ ì‹œë„
            if (!foundBook) {
                const numericInput = inputUpper.replace(/[^0-9X]/gi, '');
                if (numericInput.length >= 10) {
                    foundBook = bookList.find(book => book.ISBN === numericInput);
                }
            }

            // 3. ì„œëª… (Title)ìœ¼ë¡œ ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
            if (!foundBook) {
                // ì´ë¯¸ í™•ì¸ëœ ì±…ì€ ê±´ë„ˆë›°ê³ , í™•ì¸ë˜ì§€ ì•Šì€ ì±… ì¤‘ì—ì„œ ì°¾ìŒ (ë„ì–´ì“°ê¸° ë¬´ì‹œ)
                const inputNoSpace = inputUpper.replace(/\s/g, '');
                foundBook = bookList.find(book => 
                    book.Title.toUpperCase().replace(/\s/g, '').includes(inputNoSpace) && !book.checked
                );
            }
            
            return foundBook;
        }
        
        // ê²€ìƒ‰ ê²°ê³¼ë¥¼ í™”ë©´ì— í‘œì‹œí•˜ê³  ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
        function displayCheckResult(foundBook, rawInput) {
            if (foundBook) {
                if (foundBook.checked) {
                    // ì´ë¯¸ í™•ì¸ëœ ê²½ìš°: ë“±ë¡ ë²ˆí˜¸ë§Œ í‘œì‹œ ìœ ì§€
                    checkResultEl.innerHTML = `<span class="text-orange-500">âš ï¸ "${foundBook.Title}"ì€ ì´ë¯¸ í™•ì¸ëœ ì±…ì…ë‹ˆë‹¤. (ë“±ë¡ ë²ˆí˜¸: ${foundBook.RegNo})</span>`;
                } else {
                    foundBook.checked = true; // ìƒíƒœ ì—…ë°ì´íŠ¸
                    renderList(); // ëª©ë¡ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
                    // í™•ì¸ ì™„ë£Œ ë©”ì‹œì§€ëŠ” ì œëª©ë§Œ í‘œì‹œ
                    checkResultEl.innerHTML = `<span class="text-green-600">âœ… [í™•ì¸ ì™„ë£Œ] "${foundBook.Title}"</span>`;
                }
            } else {
                // ì°¾ì§€ ëª»í•œ ê²½ìš°: ì…ë ¥ê°’ë§Œ í‘œì‹œ ìœ ì§€
                checkResultEl.innerHTML = `<span class="text-red-500">âŒ "${rawInput}" ëª©ë¡ì—ì„œ ì¼ì¹˜í•˜ëŠ” ì±…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>`;
            }
        }

        // í˜„ì¬ ëª©ë¡ ìƒíƒœë¥¼ ì—‘ì…€ íŒŒì¼ë¡œ ë‚´ë³´ë‚´ëŠ” í•¨ìˆ˜ (SheetJS ì‚¬ìš©)
        function exportToExcel() {
            if (bookList.length === 0) {
                showMessage("ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜", "ë‚´ë³´ë‚¼ ë„ì„œ ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.");
                return;
            }
            
            // 1. ìµœì¢… í—¤ë” êµ¬ì„±: ì›ë³¸ í—¤ë” + ['í™•ì¸ ìƒíƒœ', 'ë¹„ê³ ']
            const finalHeaders = [...originalExcelHeaders, 'í™•ì¸ ìƒíƒœ', 'ë¹„ê³ '];
            
            // 2. ë°ì´í„°ë¥¼ í—¤ë” ìˆœì„œì— ë§ê²Œ ë°°ì—´ë¡œ êµ¬ì„±í•©ë‹ˆë‹¤.
            const dataForSheet = bookList.map(book => {
                const row = {};

                // ì›ë³¸ ë°ì´í„° í•„ë“œë¥¼ ë¨¼ì € ì±„ì›ë‹ˆë‹¤.
                originalExcelHeaders.forEach(header => {
                    // ì›ë³¸ ë°ì´í„° í•„ë“œ ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤. ê°’ì´ ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´ ì²˜ë¦¬
                    row[header] = book.OriginalData[header] || '';
                });

                // ë§¨ ëì— ì¶”ê°€ëœ í•„ë“œë¥¼ ì±„ì›ë‹ˆë‹¤.
                row['í™•ì¸ ìƒíƒœ'] = book.checked ? 'í™•ì¸ ì™„ë£Œ (âœ“)' : 'ë¯¸í™•ì¸ (â–¡)';
                row['ë¹„ê³ '] = book.Remarks || '';

                return row;
            });
            
            // 3. SheetJSë¥¼ ì‚¬ìš©í•˜ì—¬ ì›Œí¬ì‹œíŠ¸ ìƒì„± ë° ë‚´ë³´ë‚´ê¸°
            const worksheet = XLSX.utils.json_to_sheet(dataForSheet, { header: finalHeaders });
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "ë„ì„œì¬ê³ í™•ì¸ê²°ê³¼");

            const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            XLSX.writeFile(workbook, `ë„ì„œ_ì¬ê³ í™•ì¸_ê²°ê³¼_${date}.xlsx`);
        }


        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        excelFileEl.addEventListener('change', loadExcel);
        checkButtonEl.addEventListener('click', searchAndCheck);
        exportButtonEl.addEventListener('click', exportToExcel);
        filterButtonEl.addEventListener('click', toggleFilter); // [ê¸°ëŠ¥ 1] í•„í„° ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        
        scanInputEl.addEventListener('keypress', function(e) {
            // ì—”í„° í‚¤ ì…ë ¥ ì‹œ ê²€ìƒ‰ ì‹¤í–‰
            if (e.key === 'Enter') {
                e.preventDefault(); // ê¸°ë³¸ í¼ ì œì¶œ ë°©ì§€
                searchAndCheck();
            }
        });

        // ì´ˆê¸°í™” ì‹œ ë¡œë“œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        document.addEventListener('DOMContentLoaded', () => {
            updateUIState(false);
        });

        // ì´ˆê¸° ëª©ë¡ ë Œë”ë§ (í”Œë ˆì´ìŠ¤í™€ë”)
        renderList();
    </script>
</body>
</html>
